#!/usr/bin/env python
#-*- coding: utf-8 -*-
                                                       
################################################################################################################################################################################ -ohh`  #####################                
#                                                                                                                                                                             -ohNMMMMd`                    #
#                                                                                                                                                                         -ohNMMMMMmMMMd`                   #
#                                                                                                                                                                     -ohNMMMMNho-  yMMMd`                  #
#                                                                                                                                                                 -ohNMMMMNho-       yMMMd`                 #
#                                                                                                                                                             -ohNMMMMNho-            yMMMd`                #
#                                                                                                                                                         -+hNMMMMMdo-                 yMMMd`               #
#                                                                                                                                                     -+hNMMMMMdo:`                     yMMMd`              #
#                                                                                                                                                 -+hNMMMMMho-                           sMMMd`             #
#                                                                                                                                                `dMMMMho-                                sMMMd`            #
#                                                                                                                                                 `dMMMo                                   sMMMd`           #
#                                                                                                                                                  `dMMMs                                   sMMMd`          #
#                                                                                                                                                   `dMMMs                                   sMMMm`         #
#                                                                                                                                                    `dMMMo         `:osyyo/.                 sMMMm`        #
#                                                                                                                                                     `dMMMo      `sNMMMMMMMMh-                sMMMm`       #
#    MMMMMMMMo mMMMMNNds-    -yNMMMMNd-      sMMs                -MMh                                    `ddh                                          `dMMMo    `mMMMMMMMMMMMM/                sMMMm`      #
#    MMM/----. mMMo--+mMMy  oMMN+.`./h:      sMMy      -+osso/.  -MMh-+so:    :osso/`  .++:`/+`-+osso/. `+MMN++/  -+sso/.  `++/`:+/++-   :++.           `dMMMo   oMMMMMMMMMMMMMm                 sMMMm.     #
#    MMMyssss` mMM/   `mMM/.MMM-             sMMy      oysosmMM/ -MMNhydMMy -mMNsodMN/ /MMNMNN.oysosmMM/.yMMMyyo`dMMyohMMo .MMNNNN+NMN. -MMd             `dMMMs  oMMMMMMMMMMMMMm              ./ymMMMMm`    #
#    MMMhyyyy` mMM/    dMMo-MMM`             sMMy      .+syhmMMs -MMh   NMM.hMM/  `MMM`/MMh    .+syhmMMs `MMN   sMMo   mMM-.MMm`   :MMh dMN.              `dMMMs `mMMMMMMMMMMMM:          `/ymMMMMMms/`     #
#    MMM.      mMM/  `oMMm` mMMy`    /.      sMMy     :MMd:-oMMs -MMh  `NMM`hMM/  `MMN`/MMy   :MMd:-oMMs `MMN   oMMs   mMM-.MMm     oMMdMM:                `dMMMs `sNMMMMMMMMh-       `/smMMMMMms/`         #
#    MMM.      mMMmdmMMNs`  `yMMNdhdNM:      sMMNmmmmd-MMNssmMMs -MMNyyNMN/ .mMNysmMN/ /MMy   -MMNssmMMs  mMMhss`hMMysdMMo .MMm      hMMMs                  `dMMMs   -+ssso/`     `/smMMMMMms/`             #
#    ///`      //////:.       `:+oo+:.       -//////// .+o+:.//- `//::++/`    -+oo+:`  .//-    .+o+:.//-   :+o+:  ./ooo/`  `///      +MMd                    `dMMMs           ./smMMMMMms/`                 #
#                                                                                                                                   .NMN.                     `dMMMs      ./ymMMMMMms/`                     #
#                                                                                                                                   `..`                       `hMMMs `/smMMMMMmy/`                         #
#                                                                                                                                                               `hMMMmMMMMMmy/.                             #
#                                             T  H  E    M  O  T  I  O  N    T  E  C  H  N  O  L  O  G  Y    I  N  N  O  V  A  T  I  O  N  S                     `hMMMMmy/.                                 #
#                                                                                                                                                                 `yy/.                                     #
#                                                                                                                                                                                                           #
#   ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  #
#                                                                                                                                                                                                           #
#                    `++++++/-`    `+++++++-   -+ooo+:  .++.     ./oooo+-   +++`     :+/   +++++++-  -++++++++++++//:.                                                                                      #
#                    .MMmyyhmMMh-  `MMmyyyy: -mMmsosyy  /MM:   +mMmyssydh   MMMN:    hMm   NMmyyyy/  oMMMMMMMMMMMMMMMMMmy+.                                                                                 #
#                    .MMo    -mMN. `MMo      sMM/       /MM:  hMN/          MMhNMo   hMm   NMy       oMMMMMMMMMMMMMMMMMMMMMh:                                                                               #
#                    .MMo     :MMo `MMmyyyy` `yMMmy+.   /MM: :MMo  `+++++.  MMs.dMh` hMm   NMmyyyy.  oMMMMM+     `.:odMMMMMMMy                                                                              #
#                    .MMo     /MM+ `MMh++++`   `:sdMMy  /MM: :MMo  `yydMM:  MMs  sMm-hMm   NMd++++`  oMMMMM+          .yMMMMMMy                                                                             #
#                    .MMo   `+NMh  `MMo      .     sMM: /MM:  dMN/    /MM:  MMs   /NMmMm   NMy       oMMMMM+            +MMMMMM:                                                                            #
#                    .MMNddmMMh/   `MMNdddds sNdyydMMy  /MM:  `omMNdhhNMM-  MMs    .dMMm   NMNddddy  oMMMMM+             hMMMMMy                                                                            #
#                     :::::-.       :::::::- `-////-`   `::`     .:///:-`   ::.      ::-   :::::::-  oMMMMM+             +MMMMMm                                                                            #
#                                                                                                    oMMMMM+             +MMMMMd                                                                            #
#                                                                                .-`                 oMMMMM+             hMMMMMs                                                                            #
#                                                                                dM:                 oMMMMM+            /MMMMMM. `mmm.    /hmmmm+ `mmmmmm`  /hmNNmy:   dmd.   -mh                           #
#                                                                                dM:-//- `//`  `/:   oMMMMM+          `oMMMMMM/  hMoMd   -MM.   ` `MM`    `dMs.  -hMy  mMmN/  :Md                           #
#                                                                                dMdo+hMy sMs  yM/   oMMMMM+       `:sNMMMMMm:  oMs yMo   sNNh+.  `MMysso +Mm     .MM. mM-sMs :Md                           #
#                                                                                dM:  `MM` dM::Ms    oMMMMMmhhhhddNMMMMMMMNo`  :MMssyMM:    -omMy `MM:::- /MN`    -MM` mM- :Nd/Md                           #
#                                                                                dMy..sMd  `mmNd     oMMMMMMMMMMMMMMMMMmy:    `NM+:::+MN`-+-.-sMm `MM/:::` yMd+::oNN/  mM-  .dMMd                           #
#                                                                                os/shy/    :MN.     /hhhhhhhhhhhyso+:`       /s+     +s/.syhys+` `ssssss-  .+yhys/`   os.    oso                           #
#                                                                                         /+mN-                                                                                                             #
######################################################################################## /+:` ###############################################################################################################

#OpenAI_hawk - version 1.0
#   what's new
#       - separated json file
#       - rapid image processing up to 25 frame per second
#       - trigered initialization command's available

#ImportParty+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
import rospy
import threading
import numpy as np
import copy
import json
import time

from geometry_msgs.msg import PoseStamped, TwistStamped 
from sensor_msgs.msg import Imu, LaserScan, Image
from gazebo_msgs.msg import LinkState, ModelState
from mavros_msgs.msg import RCIn, State 

#Setups+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
fileDerectory = "/home/daseonbig16/Documents/LandingData/"

#Variable Initialization++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
isstartkey  = False
isstopkey   = False

#dictionary
LandingDim      = {'centerCoord':[0.04,0.18,0.03], 'width':0.5, 'height':0.5}
IMGresolution   = {'width':320, 'height':240}
ScanInfo        = {'num_of_dots':1440}

#Global Variable Initialization
Lpose_x         = 0.                                                                    
Lpose_y         = 0.
Lpose_z         = 0.
Lvel_x          = 0.0
Lvel_y          = 0.0
Lvel_z          = 0.0
Att_x           = 0.
Att_y           = 0.
Att_z           = 0.
Att_w           = 0.
Stamp           = 0.
PosAtt_flag     = 0
FMode           = 0
raw_image       = np.zeros( IMGresolution['width'] * IMGresolution['height'] * 3, dtype = np.uint8 )
ThrottleCMD     = 0
YawRateCMD      = 0
RollCMD         = 0
PitchCMD        = 0
clearanceCMD    = 9999
prevstamp       = 0
Stamp_secs      = 0
Stamp_nsecs     = 0
WholeSaler      = {}
thisrunSaler    = {}
thisframeSaler  = {}
sequenceCounter = 0
frameCounter    = 0
runCounter      = 0
savedflag       = False
initializeflag  = False
firstdataget    = False 
view1           = np.zeros( IMGresolution['width'] * IMGresolution['height'] * 3, dtype = np.uint8 )
view2           = np.zeros( IMGresolution['width'] * IMGresolution['height'] * 3, dtype = np.uint8 )
view3           = np.zeros( IMGresolution['width'] * IMGresolution['height'] * 3, dtype = np.uint8 )
GSviz           = np.zeros( [IMGresolution['height'] , IMGresolution['width']], dtype = np.uint8 )
clearanceCMD    = 1999

#SubscriberCallbacks+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
def getLocalPose_Att(msg):                                                            

    global Lpose_x                                                                    
    global Lpose_y
    global Lpose_z

    global Att_x
    global Att_y
    global Att_z
    global Att_w

    global Stamp

    global PosAtt_flag

    Lpose_x = msg.pose.position.x                                                       
    Lpose_y = msg.pose.position.y                                                     
    Lpose_z = msg.pose.position.z

    Att_x   = msg.pose.orientation.x                                                       
    Att_y   = msg.pose.orientation.y                                                       
    Att_z   = msg.pose.orientation.z      
    Att_w   = msg.pose.orientation.w
    
    Stamp   = msg.header.stamp.secs + ( float( '0.' + str(msg.header.stamp.nsecs) ) )
    Stamp_secs  = msg.header.stamp.secs
    Stamp_nsecs = msg.header.stamp.nsecs 

def getLocalVel(msg):
    #not body-frame
    
    global Lvel_x                                                                    
    global Lvel_y
    global Lvel_z

    Lvel_x = msg.twist.linear.x
    Lvel_y = msg.twist.linear.y
    Lvel_z = msg.twist.linear.z

def getPixState(msg):
    global FMode

    Rawdat = msg.mode

    if Rawdat == 'Manual':
        k = 0
    elif Rawdat == 'Altitude':
        k = 1
    elif Rawdat == 'Position':
        k = 2
    else:
        k = 3
        pass

    FMode = k

def getRCsignal(msg):
    global ThrottleCMD
    global YawRateCMD
    global RollCMD
    global PitchCMD
    global clearanceCMD

    ThrottleCMD     = msg.channels[2]
    YawRateCMD      = msg.channels[3]
    RollCMD         = msg.channels[0]
    PitchCMD        = msg.channels[1]
    clearanceCMD    = msg.channels[4]

def getVisual1(msg):
    global view1
    #lili = (msg.data)
    #sT4 = time.time()
    view1 = np.fromstring(msg.data, np.uint8)
    #print 'data conversion dur : %f'%(time.time()-sT4)
    
def getVisual2(msg):
    global view2
    #lili = (msg.data)
    view2 = np.fromstring(msg.data, np.uint8)
    
def getVisual3(msg):
    global view3
    #lili = (msg.data)
    view3 = np.fromstring(msg.data, np.uint8)
    #view3 = np.array([ord(i) for i in msg.data])

#Functions++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
def OneWitch():
    global PX4manipulation
    PX4manipulation.pose.position.x     = 57.15
    PX4manipulation.pose.position.y     = -21.881
    PX4manipulation.pose.position.z     = 25.0

    PX4manipulation.pose.orientation.x  = 0.00067135 
    PX4manipulation.pose.orientation.y  = -0.0026451
    PX4manipulation.pose.orientation.z  = 0.9935357
    PX4manipulation.pose.orientation.w  = 0.1135184
      
def OneWitchSet():                      # 쓰레기
    global PX4_witch_set
    PX4_witch_set.header.stamp.secs     = Stamp_secs
    PX4_witch_set.header.stamp.nsecs    = Stamp_nsecs
    PX4_witch_set.header.frame_id       = 'map'
      
    PX4_witch_set.pose.position.x       = 57.15
    PX4_witch_set.pose.position.y       = -21.881
    PX4_witch_set.pose.position.z       = 25.0
      
    PX4_witch_set.pose.orientation.x    = 0.00067135 
    PX4_witch_set.pose.orientation.y    = -0.0026451
    PX4_witch_set.pose.orientation.z    = 0.9935357
    PX4_witch_set.pose.orientation.w    = 0.1135184
      
def isitLandedQuestionmark(curpose):
    if (( curpose[0] <= LandingDim['centerCoord'][0] + LandingDim['width'] ) & ( curpose[0] >= LandingDim['centerCoord'][0] - LandingDim['width'] )\
       &( curpose[1] <= LandingDim['centerCoord'][1] + LandingDim['width'] ) & ( curpose[1] >= LandingDim['centerCoord'][1] - LandingDim['width'] )\
       &( curpose[2] <= LandingDim['centerCoord'][2] + LandingDim['height']) & ( curpose[2] >= LandingDim['centerCoord'][2] - LandingDim['height'])):
        return True
    else:
        return False
      
def VisualHexahedralize(dat):           # Compile the raw data into hexahedral matrix
    VHexahedron = copy.copy(dat.reshape(IMGresolution['height'],IMGresolution['width'],3).astype(np.uint8))#reshape(480,640,3)
    return VHexahedron

def MakeGS(jointdat):
    sT4 = time.time()
    GSviz = (jointdat[:,:,0] + jointdat[:,:,1] + jointdat[:,:,2])/3
    print 'Dur : %f'%(time.time()-sT4)
    return GSviz

# def MakeGS_threading(jointdat):                   # RGB8 to Greyscale converter
#     sT4 = time.time()

#     def do_work_square(te,be,le,re):
#         global GSviz
#         #print te,be,le,re
#         for r in range(te,be):
#             for c in range(le,re):
#                 GSviz[r,c] = np.uint8 ( float( np.uint16(jointdat[r,c,0]) + np.uint16(jointdat[r,c,1]) + np.uint16(jointdat[r,c,2]) )/3 )
#     slicenum = 1
#     threadss = []     

#     for ber in range(slicenum):
#         for num in range(slicenum):
#             thh = threading.Thread(target=do_work_square, \
#                 args=((IMGresolution['height']/slicenum)*ber,(IMGresolution['height']/slicenum)*(ber+1),(IMGresolution['width']/slicenum)*num,(IMGresolution['width']/slicenum)*(num+1)))
#             thh.start()
#             threadss.append(thh)
    
#     for thh in threadss:
#         thh.join()
#     print 'Dur : %f'%(time.time()-sT4)

#     return GSviz
      
def gatherData_thisframe(stamp, views, velvec):
    
    thisframeSaler  = {"stamp":stamp, "cam":views, "velvec":velvec}
    
    return thisframeSaler
      
def gatherData_thisrun(frameSaler,frame=0):
    global frameCounter
    global thisrunSaler    
    if frameSaler == 'bringME':
        return thisrunSaler[frame]

    elif frameSaler == 'clearCMD':
        thisrunSaler = {}
        frameCounter = 0
        print 'clearRAM'

    else:
        thisrunSaler.update( {frameCounter:frameSaler} )
        frameCounter    = frameCounter + 1
        #runCounter   = runCounter + 1
        #return thisrunSaler

def gatherData_Whole(runSaler):
    global sequenceCounter    
    WholeSaler.update( {sequenceCounter:runSaler} )

    sequenceCounter = sequenceCounter + 1
    return WholeSaler 

def save_jason(frame,data):
    sT5 = time.time()
    jstring = json.dumps(data, indent=4)
    filename = fileDerectory + 'landingdat' + '_' + '%d'%sequenceCounter + '_' + '%d'%frame + '.json'
    f = open(filename, "w")
    f.write(jstring)
    f.close()
    print 'saving dur : %f'%(time.time()-sT5)

def jasonSerializablize(numpyarray):
    listizedArray = numpyarray.tolist()
    return listizedArray

#ROSNodeInitialization++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
rospy.init_node('OpenAIhawk')


#Manipulation-Initialization++++++++++++++++++++++++++++++++++++++++++++++++++++++++
PX4manipulation                     = ModelState()
PX4manipulation.model_name          = 'iris_triplecam_env'                       #수정해야되.
OneWitch()

#PX4_witch_set                       = PoseStamped()
#OneWitchSet()

#Subscriber-Initialization++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
aquiz_px4_pose_att_dat  = rospy.Subscriber('/mavros/local_position/pose',               PoseStamped,    getLocalPose_Att    )
aquiz_px4_vel_dat       = rospy.Subscriber('/mavros/local_position/velocity_local',     TwistStamped,   getLocalVel         )
aquiz_px4_state         = rospy.Subscriber('/mavros/state',                             State,          getPixState         )
aquiz_px4_RC            = rospy.Subscriber('/mavros/rc/in',                             RCIn,           getRCsignal         ) 

aquiz_camera_dat1        = rospy.Subscriber('/iris_triplecam_env/usb_cam/image_raw',    Image,          getVisual1          ) 
aquiz_camera_dat2        = rospy.Subscriber('/iris_triplecam_env/usb_cam_2/image_raw',  Image,          getVisual2          ) 
aquiz_camera_dat3        = rospy.Subscriber('/iris_triplecam_env/usb_cam_3/image_raw',  Image,          getVisual3          ) 
                                                                                                                            
#Publisher-Initialization+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++                    
cmd_cube_pub            = rospy.Publisher('/gazebo/set_model_state',                    ModelState,     queue_size=1        )
cmd_set_pos             = rospy.Publisher('/mavros/setpoint_position/local',            PoseStamped,    queue_size=1        )
rate = rospy.Rate(25)

#++++++++++++++++++++++++++++++Initialization Ends++++++++++++++++++++++++++++++++++
prevstamp = 0
# cmd_cube_pub.publish(PX4manipulation)
#ItStarts+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
while ~rospy.is_shutdown():
    sT6 = time.time() 
    if (clearanceCMD > 1900) & (firstdataget == False) :
        
        while (clearanceCMD > 1900):
            print 'pull down the trigger so it is on the second phase'
        pass

    elif (clearanceCMD > 1900) & (firstdataget == True): 
        print 'Cessation command detected, byebye'
        break

    curpose = [Lpose_x, Lpose_y, Lpose_z]
    # gather data of the frame and append'em into the thisrun data set
    '''
    gatheredRun =  gatherData_thisrun(\
                                gatherData_thisframe(   Stamp, \
                                                        {"cam1":jasonSerializablize( MakeGS( VisualHexahedralize( view1 ) )), \
                                                         "cam2":jasonSerializablize( MakeGS( VisualHexahedralize( view2 ) )), \
                                                         "cam3":jasonSerializablize( MakeGS( VisualHexahedralize( view3 ) ))},\
                                                        [ Lvel_x, Lvel_y, Lvel_z ] ) \
    ) 
    '''
    
    print Lvel_x
    if (savedflag == False) & (clearanceCMD > 1490):
            print 'saving'
            #updated = gatherData_Whole( gatheredRun )
            #save_jason( updated )
            
            abcd = gatherData_thisframe( Stamp, \
                                        {"cam1":jasonSerializablize( MakeGS( VisualHexahedralize( view1 ) )), \
                                         "cam2":jasonSerializablize( MakeGS( VisualHexahedralize( view2 ) )), \
                                         "cam3":jasonSerializablize( MakeGS( VisualHexahedralize( view3 ) ))},\
                                         [ Lvel_x, Lvel_y, Lvel_z ] )
            gatherData_thisrun(abcd)
            #save_jason(abcd)
            
            savedflag = True
            if firstdataget == False : 
                firstdataget = True
                clearanceCMD = 1899
            
            
   
    
    
    if (clearanceCMD < 1490) :
        
        OneWitch()
        
        cmd_cube_pub.publish(PX4manipulation)
        
        if initializeflag == False:
            sequenceCounter = sequenceCounter + 1
            
            for framenum in range(frameCounter):
                save_jason(framenum, gatherData_thisrun('bringME',framenum))
                print 'saved' + '_' + '%d'%sequenceCounter + '_' + '%d'%framenum + '/' +'%d'%frameCounter
                cmd_cube_pub.publish(PX4manipulation)
                if (clearanceCMD > 1900) & (firstdataget == True): 
                    print 'Cessation command detected, byebye'
                    break

            gatherData_thisrun('clearCMD')
            initializeflag = True
        frameCounter = 0
        print 'initialization command is detected, switch the trigger to the middle'

    
    else:
        initializeflag = False
        print 'new sequence started'

    if( (isitLandedQuestionmark(curpose) == True) ):
        print 'landed properly' #는 local position이 순간이동하면 최신화가 안되기 때문에 뜨기 힘듬
    print 'CMD', clearanceCMD
    savedflag = False
    rate.sleep()
    print 'loop_dur : %f'%(time.time()-sT6)
    
quit()

